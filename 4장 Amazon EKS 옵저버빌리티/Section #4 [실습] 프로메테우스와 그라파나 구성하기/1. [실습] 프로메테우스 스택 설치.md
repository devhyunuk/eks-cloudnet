# 1. [실습] 프로메테우스 스택 설치
- 목적 : 아마존 EKS 환경에서 프로메테우스와 그라파나를 통해 매트릭을 수집하고 대시보드로 구현하는 것
- 구현 중 복잡한 프로메테우스 쿼리에 대한 부분이 발생 학습필요.

1) 프로메테우스 스택 이란? : 프로메테우스 오퍼레이터를 사용해 프로메테우스 모니터링에 필요한 다양한 요소를 단일 스택으로 제공.
   - 프로메테우스 스택을 통해 프로메테우스 + 그라파나 + AlertManager 을 한 번에 설치 가능
 
![image](https://github.com/devhyunuk/eks-cloudnet/assets/49749510/b4a0bff2-90d7-413b-9e6d-317dd3d588d9)
1) 설치 -> 확인 -> 도식화

# 1. 프로메테우스 스택 설치

## 1.1. 프로메테우스 스택 설치


### 1.1.1 신규터미널 - 네임 스페이스 추가 및 모니터링
```
// monitoring 네임 스페이스 추가
kubectl create ns monitoring

kubectl get ns
```
![image](https://github.com/devhyunuk/eks-cloudnet/assets/49749510/918f42eb-7245-4e99-8755-4d0a23e56ab6)
1) 프로메테우스 스택에서 생성될 자원이 위치할 네임스페이스를 생성하고 확인.

```
// 신규 터미널 - pod, svc, ingress, pv, pvc 모니터링 수
watch kubectl get pod,svc,ingress,pv,pvc -n monitoring
```
![image](https://github.com/devhyunuk/eks-cloudnet/assets/49749510/83535504-cbaa-4ec4-91b1-d4b2e135401a)
1) 최초 생성된 자원 없음 확인.


### 1.1.2 helm repo 추가
```
// helm chart repository 추가
helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
```
![image](https://github.com/devhyunuk/eks-cloudnet/assets/49749510/456a1dc2-7f20-4a99-8d50-fde032fa9137)
1) 프로메테우스 스택을 생성하기 위해 helm chart repository 추가
   - 프로메테우스 스택을 제공하는 프로메테우스 커뮤니티 리파지토리가 추가된것 메시지 확인.

### 1.1.3 프로메테우스 스택 설치
```
// 파라미터 파일 다운로드 및 확인
curl -s -O https://raw.githubusercontent.com/cloudneta/cnaeblab/master/_data/monitor-values.yaml

cat monitor-values.yaml | yh
```
1) 프로메테우스 스택을 설치하기 위한 파라미터를 구성
   -  파라미터를 정의한 파일을 다운로드하고 확인.

![image](https://github.com/devhyunuk/eks-cloudnet/assets/49749510/54137ef1-f689-4034-ba0e-5955a3d09056)
![image](https://github.com/devhyunuk/eks-cloudnet/assets/49749510/83217ca0-bf55-43b0-b310-150a94bb6b10)
1) 상단에 프로메테우스를 정의한 영역으로 아래 프로메테우스 스펙을 정의.
   - retention : 5일 (retention의 의미 : 매트릭 정보를 보유하는 기간이나 보유 사이즈를 정의)
   - retention size : 10GB
     - 즉, 최대 5일간 수집된 매트릭을 보유하고 최대 10GB까지 수집된 매트릭을 보유하는 정의.
     - 해당 기간이나 용량을 넘어서면 오래된 데이터부터 삭제. (구성된 환경에 따라 적절한 값을 설정 필요)
   - 스토리지 클래스 : 기본 설정에서 생성한 GP3를 사용

![image](https://github.com/devhyunuk/eks-cloudnet/assets/49749510/3140b372-1f88-483d-8659-1885ffd56890)
1)  프로메테우스의 외부 노출을 위해 인그레스인 ALB를 구성 (Bitnami nginx를 구성할 때와 동일한 형태로 구성)
2)  호스트는 프로메테우스의 자신의 도메인 형태로 HTTP나 HTTPS에 대해 모두 처리가 가능 하도록 설정.

![image](https://github.com/devhyunuk/eks-cloudnet/assets/49749510/a2bbeb3d-a555-4608-a9a1-ef3bc4378a36)
![image](https://github.com/devhyunuk/eks-cloudnet/assets/49749510/df003b40-6d35-4897-b7c7-395785eb54ee)
1) Graphana를 정의하는 영역
   - Persistence의 유형 : PVC
   - 스토리지 클래스 : GP3

```
// 환경 변수 선언
export MyDomain=$MyDomain CERT_ARN=$CERT_ARN
```
![image](https://github.com/devhyunuk/eks-cloudnet/assets/49749510/21d142bd-abf7-4cca-89f2-6f9596a29dcc)

```
// 프로메테우스 스택 배포
envsubst < monitor-values.yaml | helm install kube-prometheus-stack prometheus-community/kube-prometheus-stack --version 45.27.2 \
  --set prometheus.prometheusSpec.scrapeInterval='15s' \
  --set prometheus.prometheusSpec.evaluationInterval='15s' \
  -f - --namespace monitoring
```
![image](https://github.com/devhyunuk/eks-cloudnet/assets/49749510/df6f7bb6-e26e-4be7-b7ff-3107a8b46486)
1) 프로메테우스 스택을 배포 -> 파라미터 파일에 환경 변수를 치환시키고 -> 프로메테우스 스택을 설치 진행
2) 빠른 설치를 위해 스크랩 인터벌과 에볼루션 인터벌 값은 짧게 설정
![image](https://github.com/devhyunuk/eks-cloudnet/assets/49749510/c079c04d-2ee3-4ca0-bdb6-29eac65b8d41)

## 1.2. 프로메테우스 설치 확인


### 1.2.1 helm list와 설치된 모든 자원 확인
```
// monitoring 네임 스페이스에 helm list 확인
helm list -n monitoring
```
![image](https://github.com/devhyunuk/eks-cloudnet/assets/49749510/2d551c63-6777-4cba-87cd-0595c132b3f6)
1) 모니터링 네임스페이스에 구성된 helm chart 리스트를 확인
   - 프로메테우스 스택이 설치 확인.

```
// monitoring 네임 스페이스에 모든 자원 확인
kubectl get-all -n monitoring
```
![image](https://github.com/devhyunuk/eks-cloudnet/assets/49749510/6e2376cb-541e-4d5b-85b7-70ba130dd800)
1) kubectl get-all 명령으로 모니터링 네임스페이스에 구성된 모든 자원을 확인
   - config-map과 endpoint와 파드와 서비스 어카운트 등등 설치확인.

### 1.2.2 sts, ds, deloy 확인
```
// monitoring 네임 스페이스에 sts, ds, deploy 확인
kubectl get sts,ds,deploy -n monitoring

// statefulset 상세 정보
kubectl describe sts -n monitoring

// daemonset 상세 정보
kubectl describe ds -n monitoring
```

### 1.2.3 crd, servicemonitors, targetgroupbindings 확인
```
// monitoring 네임 스페이스에 sts, ds, deploy 확인
kubectl get crd | grep monitoring

kubectl get servicemonitors -n monitoring

kubectl get targetgroupbindings -n monitoring
```



















