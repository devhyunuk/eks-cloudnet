# Section #3 [실습] Amazon EKS 배포

## 2 관리 콘솔에서 Amazon EKS 배포
   
   ### 2.1 관리 콘솔에서 Amazon EKS 클러스터 생성과정
      
   ![image](https://github.com/devhyunuk/eks-cloudnet/assets/49749510/2357c2b7-3791-4653-a336-6369c86f1c85)

   1) 관리 콘솔에서 EKS 클러스터를 생성하면 -> AWS 관리용 VPC의 컨트롤 플레인이 구성됨
   2) 컨트롤 플레인을 구성할 때 EC2나 오토 스케일링이나 ELB 등이 자동으로 구성됨
      - 아마존 EKS가 AWS 자원을 구성하기 위한 권한이 필요
      - IAM 역할을 생성하는 작업이 선행 (이후 아마존 EKS의 자격 증명을 수행하고 생성)
   3) EKS 관리용 인스턴스(MyEKShost)에 생성된 EKS 클러스트 정보를 업데이트 수행
   4) 관리형 노드그룹으로 노드를 구성
      - 노드그룹의 AWS 자원을 동적으로 구성하기 위해 IAM 역할이 필요

   #### 2.1.1 [관리 콘솔] EKS 클러스터 IAM Role 생성

   ![image](https://github.com/devhyunuk/eks-cloudnet/assets/49749510/7fe12d26-8afa-4a0b-9664-cfebbfa87e48)

   ![image](https://github.com/devhyunuk/eks-cloudnet/assets/49749510/822e4842-1c49-4202-95f9-42f76423f309)
   1) 신뢰할 수 있는 엔터티 선택 : 대상은 EKS, 액션은 STS Assume role
      - STS는 보안 토큰을 통해 AWS 외부 자격을 증명하는 것
      - Assume role은 AWS 자원에 접근할 수 있는 자격 증명을 의미

   #### 2.1.2 [관리 콘솔] EKS 클러스터 추가 생성

   ![image](https://github.com/devhyunuk/eks-cloudnet/assets/49749510/53e4bdd3-b104-4c40-8e26-bf7b7ac7da7f)

   ![image](https://github.com/devhyunuk/eks-cloudnet/assets/49749510/0a4c0361-5d12-4c18-bcd8-b88aee0e5921)

   ![image](https://github.com/devhyunuk/eks-cloudnet/assets/49749510/4c44aae4-2500-4301-8950-20be3085277c)
   
   ![image](https://github.com/devhyunuk/eks-cloudnet/assets/49749510/cddb9cd2-f9b2-4328-a6a5-180071df72eb)

   ![image](https://github.com/devhyunuk/eks-cloudnet/assets/49749510/b83d8070-f90c-4893-a301-8750223fb244)

   ##### 배포되는 자원의 구성도

   ![image](https://github.com/devhyunuk/eks-cloudnet/assets/49749510/ed27f344-cbc0-47c4-a001-7833f39fbd96)

   - 컨트롤 플레인 자원이 AWS 관리용 VPC에 생성
   - AWS 자원을 생성할 수 있도록 IAM eksClusterRole을 구성하고 연결
   - 2개의 가용 영역에서 서브넷 4개가 생성
   - 클러스터 엔드포인트 액세스 : Public으로 설정함에 따라 IGW도 구성
   - 두 개의 가용 영역에서 컨트롤 플레인 자원인 API 서버, 컨트롤러, 스케줄러 각각 생성
   - 또 다른 서브넷에 ETDC가 생성
   - 부하 분산을 위해 ELB가 구성
   - 오토 스케일링 서비스도 구성

   #### 2.1.3 EKS 클러스터 정보를 kubeconfig 등록

   - EKS 클러스터를 생성하였지만 kubeconfig에 등록하지 않아 아래와 같이 에러가 발생함.
   - myeks-host에 생성한 클러스터 보안 정보를 업데이트해야 kubectl 명령어를 수행 가능.
   ```
   [root@myeks-host ~]# kubectl get svc
   The connection to the server localhost:8080 was refused - did you specify the right host or port?
   ```

   - myeks-host가 관리하는 EKS 클러스터 정보는 kube 폴더의 config 파일에 기록
   - 기본적으로 없으니 update 명령어를 통해 생성 필요.
   ```
   [root@myeks-host ~]# cat ~/.kube/config | yh
   cat: /root/.kube/config: No such file or directory

   // EKS 클러스터 정보 업데이트
   [root@myeks-host ~]# aws eks update-kubeconfig --region $AWS_DEFAULT_REGION --name $CLUSTER_NAME
   Added new context arn:aws:eks:us-west-2:308943070041:cluster/myeks to /root/.kube/config
   (arn:aws:eks:us-west-2:308943070041:cluster/myeks:N/A)

   // kubeconfig 정보 확인
   (arn:aws:eks:us-west-2:308943070041:cluster/myeks:N/A) [root@myeks-host ~]# cat ~/.kube/config | yh
   apiVersion: v1
   clusters:
   - cluster:
       certificate-authority-data:

   // 생성한 Kubernetes 서비스 확인
   (arn:aws:eks:us-west-2:308943070041:cluster/myeks:N/A) [root@myeks-host ~]# kubectl get svc
   NAME         TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE
   kubernetes   ClusterIP   10.100.0.1   <none>        443/TCP   8m40s

   // kube_ps1 비활성화
   (arn:aws:eks:us-west-2:308943070041:cluster/myeks:N/A) [root@myeks-host ~]# kubeoff
   [root@myeks-host ~]#
   ```
   - kubeconfig를 update 하고 나면 svc가 출력되는 것을 확인 할 수 있다.

---

   ### 2.2 Amazon EKS 노드 생성 (관리 콘솔)

   #### 2.2.1 EKS 노드 IAM Role의 신뢰 엔터티 설정

   - EKS 클러스터를 생성하였지만 kubeconfig에 등록하지 않아 아래와 같이 에러가 발생함.


   #### 2.2.2 EKS 노드 IAM Role 생성

   #### 2.2.3 EKS 노드 IAM Role 확인
     
   #### 2.2.4 [관리 콘솔] EKS 관리형 노드 그룹 생성
