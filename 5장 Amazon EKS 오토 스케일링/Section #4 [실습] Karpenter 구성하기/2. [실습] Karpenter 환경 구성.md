# 2. [실습] Karpenter 환경 구성

![image](https://github.com/devhyunuk/eks-cloudnet/assets/49749510/c212012f-fc4b-4aa1-b96b-3260dbecfb33)
- Karpenter 동작 확인에 앞서 Karpenter 설치와 Provisioner 정책을 생성하는 작업을 수행한다.

1) Karpenter를 설치하고 확인하는 작업을 진행
   - 설치에 사용할 환경 변수를 선언하고
   - Karpenter를 설치
   - Karpenter 설치를 통해 생성된 자원들을 확인
  
2) Karpenter 구성의 핵심적인 요소인 Provisioner 정책을 생성
   - Provisioner을 통해 노드가 구성될 인스턴스 형태를 지정하고
   - AWSNodeTemplate을 통해 AWS 환경에서 노드가 위치할 구성을 정의한다.
  
3) 생성된 Provisioner 정책과 AWSNodeTemplate 정책을 확인 한다.

---

## 2.1. Karpenter 설치 및 확인


### 2.1.1 환경 변수 설정
```
// Karpenter 설치를 위한 환경 변수 설정 및 확인
export CLUSTER_ENDPOINT="$(aws eks describe-cluster --name ${CLUSTER_NAME} --query "cluster.endpoint" --output text)"

export KARPENTER_IAM_ROLE_ARN="arn:aws:iam::${AWS_ACCOUNT_ID}:role/${CLUSTER_NAME}-karpenter"

echo $CLUSTER_ENDPOINT; echo $KARPENTER_IAM_ROLE_ARN
```
![image](https://github.com/devhyunuk/eks-cloudnet/assets/49749510/4935cded-f7d2-41db-93ae-4fd8a1b79129)
1) 

### 2.1.2 EC2 Spot fleet의 server-linked-role 확인
```
// EC2 Spot Fleet 사용을 위한 service-linked-role 생성 확인 (이미 생성됐다는 에러가 나와야 정상)
// An error occurred (InvalidInput) when calling the CreateServiceLinkedRole operation...

aws iam create-service-linked-role --aws-service-name spot.amazonaws.com || true
```
- Warning: 만약 에러 메시지가 아닌 새롭게 생성하는 메시지가 나온다면 현재 어카운트에 해당 서비스 연결 역할(AWSServiceRoleForEC2Spot)이 존재하지 않는 것 입니다. 서비스 연결 역할 생성 후 다음 단계로 넘어가면 됩니다. 처음부터 다시 진행할 필요는 없습니다.



### 2.1.3 public.ecr.aws logout
```
// docker logout
docker logout public.ecr.aws

// helm registry logout
helm registry logout public.ecr.aws
```

### 2.1.4 Karpenter 설치
```
// karpenter 설치
helm upgrade --install karpenter oci://public.ecr.aws/karpenter/karpenter --version ${KARPENTER_VERSION} --namespace karpenter --create-namespace \
  --set serviceAccount.annotations."eks\.amazonaws\.com/role-arn"=${KARPENTER_IAM_ROLE_ARN} \
  --set settings.aws.clusterName=${CLUSTER_NAME} \
  --set settings.aws.defaultInstanceProfile=KarpenterNodeInstanceProfile-${CLUSTER_NAME} \
  --set settings.aws.interruptionQueueName=${CLUSTER_NAME} \
  --set controller.resources.requests.cpu=1 \
  --set controller.resources.requests.memory=1Gi \
  --set controller.resources.limits.cpu=1 \
  --set controller.resources.limits.memory=1Gi \
  --wait
```

### 2.1.5 Karpenter 설치 확인
```
// karpenter 설치 확인
kubectl get-all -n karpenter

kubectl get all -n karpenter

kubectl get cm -n karpenter karpenter-global-settings -o jsonpath={.data} | jq

kubectl get crd | grep karpenter
```

## 2.2. Provisioner 생성 및 확인


### 2.2.1 Provisioner와 AWSNodeTemplate 생성
```
// Provisioner와 AWSNodeTemplate 정책을 정의하고 생성
cat <<EOF | kubectl apply -f -
apiVersion: karpenter.sh/v1alpha5
kind: Provisioner
metadata:
  name: default
spec:
  requirements:
    - key: karpenter.sh/capacity-type
      operator: In
      values: ["spot"]
  limits:
    resources:
      cpu: 1000
  providerRef:
    name: default
  ttlSecondsAfterEmpty: 30
---
apiVersion: karpenter.k8s.aws/v1alpha1
kind: AWSNodeTemplate
metadata:
  name: default
spec:
  subnetSelector:
    karpenter.sh/discovery: ${CLUSTER_NAME}
  securityGroupSelector:
    karpenter.sh/discovery: ${CLUSTER_NAME}
EOF
```

### 2.2.2 Provisioner와 AWSNodeTemplate 확인
```
kubectl get awsnodetemplates,provisioners
```
























