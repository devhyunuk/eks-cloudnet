# 1. [실습] 실습 기본 환경 구성
- 목표 : Amazon EKS 환경에서 Karpenter를 구성하고 오토 스케일링을 확인한다.
- CloudFormation 스택을 실행하고 파라미터를 입력하면 실습 기본 환경 자동 구성
  - Amazon EKS 원클릭 배포가 아닌 별도의 클라우드 포메이션 스택을 배포해서 진행
![image](https://github.com/devhyunuk/eks-cloudnet/assets/49749510/85748c08-a23b-4548-a0d7-b2d022e464c6)

1) karpenter preconfig 파일로 CloudFormation 스택을 배포한다.
   - 원클릭 배포와 동일하게 파라미터를 정의하고 스택을 생성한다.
   - 작업용 Bastion Host 인스턴스에 접속해 작업을 진행한다.
   - CloudFormation 스택은 기반 환경만 구성 -> EKS 클러스터는 별도로 생성한다.
  
2) EKS 클러스터를 생성한다.
   - karpenter 환경에 맞게 EKS 클러스터 환경을 구성하는 것으로 다양한 환경 변수를 정의하고 사용하여 생성한다.
   - eksctl 명령으로 EKS 클러스터를 생성
  
3) EKS 클러스터 확인과 실습에 활용할 추가적인 도구를 설치한다.

---

# 1. 실습 기본 환경 구성
- 5장의 Karpenter 구성하기 실습을 위해 기본 인프라 환경을 CloudFormation 스택으로 생성하고 -> eksctl로 Amazon EKS 클러스터 배포한다.



## 1.1. Karpenter Preconfig 배포
- AWS CloudFormation에서 karpenter-preconfig.yaml를 import 파라미터를 입력 후 스택을 생성한다.
- Note: AWS 관리 콘솔에 로그인 할때 IAM 사용자 계정으로 진행한다.



[관리 콘솔] CloudFormation 파라미터 설정

스택 생성 페이지에서 다음 버튼을 클릭합니다.
스택 이름은 [myeks2]로 입력합니다.
KeyName은 [각자의 키페어]를 선택합니다.
MyIAMUserAccessKeyID는 [각자의 액세스 키 ID 값]을 입력합니다.
MyIAMUserSecretAccessKey는 [각자의 시크릿 액세스 키 값]을 입력합니다.
SgIngressSshCidr는 [각자의 PC의 퍼블릭 IP 주소/32]로 입력합니다.
나머지 파라미터는 기본 값을 유지하고 다음 버튼을 클릭합니다.


Warning: 설정을 마치고 약 5분 정도 대기 시간이 흐른 뒤 기본 인프라 환경 생성이 완료됩니다. 반드시 해당 대기 시간이 지난 후 다음 작업을 수행합니다.




1.2. EKS 클러스터 생성


AWS CloudFormation 스택의 출력 탭에서 eksctlhost의 퍼블릭 IP를 확인합니다.
해당 IP로 EKS 관리용 인스턴스(myeks-bastion-EC2)에 SSH로 접속하고 아래 명령어를 통해 정보를 확인합니다.



환경 변수

// 환경 변수 정보 확인
export | egrep 'ACCOUNT|AWS_|CLUSTER' | egrep -v 'SECRET|KEY'

// 환경 변수 설정
export KARPENTER_VERSION=v0.30.0
export TEMPOUT=$(mktemp)

echo $KARPENTER_VERSION; echo $CLUSTER_NAME; echo $AWS_DEFAULT_REGION; echo $AWS_ACCOUNT_ID $TEMPOUT


Warning: CloudFormation 스택이 생성되고 환경 변수가 선언되기 전에 너무 빨리 접속하면 다시 접속합니다.



Karpenter 관련 IAM, EC2 Instance Profile 생성

// CloudFormation 스택으로 IAM Policy, Role, EC2 Instance Profile 생성
// 약 3분 정도 소요
curl -fsSL https://raw.githubusercontent.com/aws/karpenter/"${KARPENTER_VERSION}"/website/content/en/preview/getting-started/getting-started-with-karpenter/cloudformation.yaml  > $TEMPOUT \
&& aws cloudformation deploy \
  --stack-name "Karpenter-${CLUSTER_NAME}" \
  --template-file "${TEMPOUT}" \
  --capabilities CAPABILITY_NAMED_IAM \
  --parameter-overrides "ClusterName=${CLUSTER_NAME}"


Amazon EKS 클러스터 생성

// EKS 클러스터 생성 : myeks2 생성
// 약 19분 정도 소요
eksctl create cluster -f - <<EOF
---
apiVersion: eksctl.io/v1alpha5
kind: ClusterConfig
metadata:
  name: ${CLUSTER_NAME}
  region: ${AWS_DEFAULT_REGION}
  version: "1.26"
  tags:
    karpenter.sh/discovery: ${CLUSTER_NAME}

iam:
  withOIDC: true
  serviceAccounts:
  - metadata:
      name: karpenter
      namespace: karpenter
    roleName: ${CLUSTER_NAME}-karpenter
    attachPolicyARNs:
    - arn:aws:iam::${AWS_ACCOUNT_ID}:policy/KarpenterControllerPolicy-${CLUSTER_NAME}
    roleOnly: true

iamIdentityMappings:
- arn: "arn:aws:iam::${AWS_ACCOUNT_ID}:role/KarpenterNodeRole-${CLUSTER_NAME}"
  username: system:node:{{EC2PrivateDNSName}}
  groups:
  - system:bootstrappers
  - system:nodes

managedNodeGroups:
- instanceType: m5.large
  amiFamily: AmazonLinux2
  name: ${CLUSTER_NAME}-ng
  desiredCapacity: 2
  minSize: 1
  maxSize: 10
  iam:
    withAddonPolicies:
      externalDNS: true
EOF


1.3. EKS 클러스터 확인 및 추가 설정


Default Namespace로 적용

// Default Namespace로 위치 변경
kubectl ns default


EKS 클러스터 확인

// EKS 클러스터 배포 확인
eksctl get cluster

eksctl get nodegroup --cluster $CLUSTER_NAME

eksctl get iamidentitymapping --cluster $CLUSTER_NAME

eksctl get iamserviceaccount --cluster $CLUSTER_NAME

kubectl describe cm -n kube-system aws-auth


신규 터미널 - EKS Node Viewer 설치

// EKS Node Viewer 설치 : 약 2분 이상 소요
// EKS 클러스터 생성 완료 후 작업
go install github.com/awslabs/eks-node-viewer/cmd/eks-node-viewer@v0.5.0

// EKS Node Viewer 접속
cd ~/go/bin && ./eks-node-viewer


ExternalDNS 설치

MyDomain=<자신의 도메인>

MyDnsHostedZoneId=$(aws route53 list-hosted-zones-by-name --dns-name "${MyDomain}." --query "HostedZones[0].Id" --output text)

echo $MyDomain, $MyDnsHostedZoneId

curl -s -O https://raw.githubusercontent.com/cloudneta/cnaeblab/master/_data/externaldns.yaml

MyDomain=$MyDomain MyDnsHostedZoneId=$MyDnsHostedZoneId envsubst < externaldns.yaml | kubectl apply -f -


kube-ops-view 설치

helm repo add geek-cookbook https://geek-cookbook.github.io/charts/

helm install kube-ops-view geek-cookbook/kube-ops-view --version 1.2.2 --set env.TZ="Asia/Seoul" --namespace kube-system

kubectl patch svc -n kube-system kube-ops-view -p '{"spec":{"type":"LoadBalancer"}}'

kubectl annotate service kube-ops-view -n kube-system "external-dns.alpha.kubernetes.io/hostname=kubeopsview.$MyDomain"

echo -e "Kube Ops View URL = http://kubeopsview.$MyDomain:8080/#scale=1.5"

   
   
   





















