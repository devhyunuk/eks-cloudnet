# 2. Amazon EKS Logging과 메트릭을 활용한 프로메테우스 & 그라파나

## 2.1 EKS 로깅의 세 가지 영역
![image](https://github.com/devhyunuk/eks-cloudnet/assets/49749510/30fd11ba-087b-46ac-adce-026c8205570c)
1) 아마존 EKS 클러스터를 설치하면
   - AWS Managed VPC에 컨트롤 플레인 자원이 구성
   - 사용자 Custom VPC에 워커노드를 구성하고 Pod를 생성하는데 Pod 내에는 컨테이너가 존재.

### 2.1.1 Control Plane Logging
1) 아마존 EKS는 AWS 관리용으로 컨트롤 플레인 영역을 알아서 관리
   - 상황에 따라 컨트롤 플레인의 로그 정보 확인이 필요
  
2) 컨트롤 플레인 자원 중에 로깅이 필요한 대상을 지정해서 활성화 가능 (아마존 EKS 클러스터를 생성할 때 기본 설정은 컨트롤 플레인 로깅이 비활성화 상태)
   - 컨트롤 플레인 자원에 로깅을 지정하면 아마존 클라우드 아치에 로그 그룹이 자동으로 생성
   - 로그 그룹의 이름은 AWS에 EKS에 클러스터 네임에 클러스터 형태로 생성.
   - 컨트롤 플레인 자원에서 발생하는 로그 정보를 Cloudwatch의 로그 그룹으로 전달해서 화면과 같은 형태의 로그 스트림을 생성. (Cloudwatch에 접근해서 해당 로그 스트림을 확인 가능)
  
### 2.1.2 Application Logging
1) 어플리케이션 : 파드에 구성되는 컨테이너를 지칭 (컨테이너 로그 정보를 확인)
   - 어플리케이션 로깅 확인
     - EBS CSI 컨트롤러 파드에 프로비저너, 어테쳐나, 리사이저 등의 컨테이너로 접근하여 kubectl 로그 명령으로 로그 정보를 확인
    
2) pod에서 컨테이너를 구성할 때 로그 정보를 기록하는 경로를 지정하고 해당 경로에 로그 정보가 쌓임. -> 컨테이너를 접근해서 명령어를 통해 로그 정보를 확인 가능.

### 2.1.3 Node Logging
1) 노드 로깅 : 워커노드 자체에서 발생하는 호스트의 로그 정보나 데이터 플레인에서 발생하는 로그 정보.
2) 아마존 EKS 자체 설정으로 노드 로깅을 지원하지 않음.
   - 별도의 도구를 설치하고 로그 정보를 수집해야 함.
   - FluentBit 도구를 사용
     - 데몬셋 형태로 설치
     - 어플리케이션 로그와 호스트 로그와 데이터 플레인 로그로 3가지 유형의 로그 정보를 수집
     - Fluentbit가 수집한 로그 정보를 -> 클라우드와치로 전달해서 로그 그룹을 생성하고 로그 스트림을 저장. (로그 인사이트나 컨테이너 인사이트 등으로 가시성 있게 확인)
    
# 3. 메트릭을 활용한 프로메테우스 & 그라파나
![image](https://github.com/devhyunuk/eks-cloudnet/assets/49749510/1e3975e8-371d-4264-8ac7-5b996118b58a)

## 3.1 Prometheus
1) 서비스 디스커버리로 대상을 지정해서 매트릭을 수집하고 시각화하며 알림기능을 제공하는 오픈소스 모니터링 도구
2) Prometheus의 구조
   - 프로메테우스 서버 (3개의 모듈로 구성)
     - Retrieval : 서비스를 찾고 매트릭을 수집하는 모듈
     - TSDB : 시계열 데이터를 저장하는 스토리지 엔진
     - HTTP 서버 : HTTP 통신용 모듈
    
3) Prometheus의 동작 흐름
   [1-1. exporters 풀 방식으로 수집]
   1. Retrieval에서 서비스 디스커버리로 대상 서비스를 찾고 대상 서비스로부터 프로메테우스 타깃인 exporters를 알아냄(감지).
   2. exporters에 저된 매트릭을 가져와서 사용 (풀 방식으로 매트릭을 수집)
     - 로메테우스 서버의 Retrieval이 exporters에 접근해서 매트릭을 가져오는 것
   3. 수집된 매트릭은 TSDB를 통해 스토리지 영역으로 저장
      - 별도의 설정이 없으면 로컬 영역에 매트릭 데이터를 저장 (프로메테우스 서버가 위치하는 파드 내부에 임시볼륨인 EmptyDIR로 저장)
      - EmptyDIR은 파드가 삭제되면 해당 볼륨도 삭제되므로, 영구 볼륨 형태로 저장 추천.
   [1-2. 클라이언트가 수집된 매트릭을 서버로 전달하는 푸쉬 방식]
   1. 푸시 게이트웨이를 구성해서 푸시 매트릭을 가져오면 프로메테우스 서버가 푸시 게이트에 접근해 매트릭을 가져오는 방식. (프로메테우스 서버는 풀 방식의 매트릭 수집을 고수)

   [2. 프로메테우스는 얼럿 매니저를 구성해서 메트릭의 특정 이벤트가 있을 때 얼럿 전달]
   1. 얼럿 매니저는 이메일이나 슬랙이나 다양한 도구로 경보를 알림.
  
   [3. 수집된 메트릭을 가시성 있게 표출하도록 데이터 시각화 도구 지원]
   1. 프로메테우스 WEB UI는 시각화 기능이 빈약해서 별도의 도구를 활용
   2. 오픈소스 시각화 도구인 그라파나
      -  그라파나는 프로메테우스 쿼리를 전달해서 받은 매트릭 정보로 굉장히 다양한 대시보드를 통해 시각화
      -  프로메테우스와 그라파나 조합으로 매트릭의 데이터 시각화 환경을 구성 추천.
      -  그라파나는 오픈소스. 공식 데시보드뿐 아니라 사용자가 직접 만든 데시보드를 공유.


       






   

























