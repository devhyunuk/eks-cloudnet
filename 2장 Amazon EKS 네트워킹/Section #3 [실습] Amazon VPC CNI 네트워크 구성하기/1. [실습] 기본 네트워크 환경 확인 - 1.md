# 1. [실습] 기본 네트워크 환경 확인 - 1

   ## 1 기본 네트워크 환경 확인
   - Amazon EKS 원클릭 배포 환경에서 진행

   ### 1.1 기본 정보 확인
   - Amazon VPC CNI 구성 환경에서 기본적인 네트워크 정보를 확인
     
   #### 1.1.1 daemonset 확인
   ```
   // kube-system의 daemonset 확인
   kubectl get daemonset -n kube-system
   ```
   ![image](https://github.com/devhyunuk/eks-cloudnet/assets/49749510/e60b3b94-1d30-4fa7-bc07-00277a2f6445)

   1) VPC CNI 플러그인이 설치된 환경에서 노드별로 구성되는 데몬셋 정보를 확인
   2) 각각의 워커노드 3대에 AWS노드와 쿠버프록시가 데몬셋 형태로 기본 설치
   3) aws-node : VPC-CNI를 위한 컴포넌트
   4) kube-proxy : 노드에 실행되는 네트워킹 컴포넌트

   ```
   // vpc-cni 정보 확인
   kubectl describe daemonset aws-node -n kube-system | grep Image | cut -d "/" -f 2
   ```
   ![image](https://github.com/devhyunuk/eks-cloudnet/assets/49749510/f0a84e49-b19e-4e2f-901e-01e54265d497)
   - vpc cni 이미지 확인

   ```
   // kube-proxy config 확인
   kubectl describe cm -n kube-system kube-proxy-config
   ```
   ![image](https://github.com/devhyunuk/eks-cloudnet/assets/49749510/8499a65e-f2d6-4964-820b-7085c025f677)

   - 노드의 네트워킹 컴포넌트인 kubeproxy 설정 정보를 확인
   - kubeproxy가 동작하는 다양한 설정 값을 확인
   - vpc cni 환경은 ip tables 모드로 동작
   - 리눅스 커널에 구성되는 ip tables를 kubeproxy가 관리 제어
     
   #### 1.1.2 워커 노드 IP와 파드 IP 확인
   ```
   // 워커 노드 IP 확인
   aws ec2 describe-instances --query "Reservations[*].Instances[*].{PublicIPAdd:PublicIpAddress,PrivateIPAdd:PrivateIpAddress,InstanceName:Tags[?Key=='Name']|[0].Value,Status:State.Name}" --filters Name=instance-state-name,Values=running --output table
   ```
   ![image](https://github.com/devhyunuk/eks-cloudnet/assets/49749510/290aa1e8-547f-4c12-8425-717310c4c206)
   
   ```
   // 파드 IP 확인
   kubectl get pod -n kube-system -o=custom-columns=NAME:.metadata.name,IP:.status.podIP,STATUS:.status.phase
   ```
   ![image](https://github.com/devhyunuk/eks-cloudnet/assets/49749510/a1b18f24-772b-4dbb-b73b-10bec1373223)

   - aws-node pod가 워커노드 3대에 설치
   - kube-proxy도 워커노드 3에 설치
   - aws-node와 kube-proxy는 워커노드의 Host Network Namespace에 위치해 인터페이스와 브리지 형태로 연결 (워커노드의 주소와 aws-node와 kube-proxy의 주소가 같은것을 확인 할 수 있다)
   - 즉, 노드의 IP와 Pod의 IP가 동일
   - 코어 DNS는 Kubernetes 클러스터 DNS 사용하는 서버
   - Amazon EKS 클러스터가 배포되면 노드 수에 상관없이 최초 두대의 coredns가 생성
   - coredns는 노드 IP와 다른 IP를 사용하는 것을 확인 할 수 있음 (Host Network Namespace가 아닌 파드 별 Network Namespace에 구성)
   - Pod IP는 vpc-cni를 통해 L-IPAM의 Warm Pool 대역에서 하나를 할당해 준다.
---
   
   ### 1.2 워커 노드에 사용할 도구 설치
   ```
   //  3대의 워커노드의 Private IP 주소 변수 저장
   N1=$(kubectl get node --label-columns=topology.kubernetes.io/zone --selector=topology.kubernetes.io/zone=ap-northeast-2a -o jsonpath={.items[0].status.addresses[0].address})
   N2=$(kubectl get node --label-columns=topology.kubernetes.io/zone --selector=topology.kubernetes.io/zone=ap-northeast-2b -o jsonpath={.items[0].status.addresses[0].address})
   N3=$(kubectl get node --label-columns=topology.kubernetes.io/zone --selector=topology.kubernetes.io/zone=ap-northeast-2c -o jsonpath={.items[0].status.addresses[0].address})
   echo "export N1=$N1" >> /etc/profile
   echo "export N2=$N2" >> /etc/profile
   echo "export N3=$N3" >> /etc/profile
   echo $N1, $N2, $N3
   
   // 3대의 워커 노드에 사용할 도구 설치
   ssh ec2-user@$N1 sudo yum install links tree jq tcpdump -y
   
   ssh ec2-user@$N2 sudo yum install links tree jq tcpdump -y
   
   ssh ec2-user@$N3 sudo yum install links tree jq tcpdump -y
   ```
   
   #### 1.2.1 워커 노드에 네트워크 정보 확인
   ```
   // 워커 노드 1에서 vpc-cni 정보 확인
   ssh ec2-user@$N1 tree /var/log/aws-routed-eni
   
   ssh ec2-user@$N1 cat /var/log/aws-routed-eni/plugin.log | jq
   
   ssh ec2-user@$N1 cat /var/log/aws-routed-eni/ipamd.log | jq
   
   // 워커 노드 1에서 네트워크 정보 확인
   ssh ec2-user@$N1 sudo ip -br -c addr
   
   ssh ec2-user@$N1 sudo ip -c route
   
   // coreDNS 파드 정보 확인
   kubectl get pod -n kube-system -l k8s-app=kube-dns -owide
   ```

---
   
   ### 1.3 테스트용 파드 생성 및 확인
   
   #### 1.3.1 신규 터미널 3개에 워커 노드 모니터링 수행
   #### 1.3.2 테스트용 netshoot 파드 3대 생성
   #### 1.3.3 테스트용 파드 이름 변수 저장
   #### 1.3.4 테스트용 파드 exec 접속 후 네트워크 정보 확인

















